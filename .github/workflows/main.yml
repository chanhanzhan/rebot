name: Release TS Project

on:
  push:
    tags:
      - 'v*' # ä»¥ v å¼€å¤´çš„ tag ä¼šè§¦å‘ï¼Œå¦‚ v1.0.0

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ›  Build TypeScript
        run: npm run build

      - name: ğŸ§ª Verify dist output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ dist directory not found!"
            exit 1
          fi

      - name: ğŸ“¦ Zip dist folder
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          ZIP_NAME=release-$VERSION.zip
          zip -r $ZIP_NAME dist
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: ğŸš€ Create GitHub Release and Upload
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body: |
            ğŸ“ è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬ï¼š**${{ github.ref_name }}**

            - ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
            - ğŸ‘¤ æäº¤äººï¼š${{ github.actor }}
            - ğŸ§¾ æäº¤ä¿¡æ¯ï¼š${{ github.event.head_commit.message }}

            âœ… é™„ä»¶åŒ…å« dist ç›®å½•ç¼–è¯‘ç»“æœã€‚
          files: ${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}  # ä½¿ç”¨ä½ è‡ªå®šä¹‰çš„ PAT

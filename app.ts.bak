import { BotFramework } from './src/core/bot-framework';
import { Logger, LogLevel } from './src/config/log';
import { ConfigInitializer } from './src/config/init';
import { RedisDatabase } from './src/config/readis';
import { DatabaseManager } from './src/database/database-manager';

async function main() {
  try {
    Logger.setLogLevel(LogLevel.INFO);
    
    // åˆå§‹åŒ–é…ç½®
    const configInit = ConfigInitializer.getInstance();
    await configInit.initialize();
    
    // è·å–æ¡†æ¶å®ä¾‹
    const framework = BotFramework.getInstance();

    const botConfig = configInit.getConfig('bot');
    if (botConfig && botConfig.database && botConfig.database.type === 'redis') {
      const redisDb = new RedisDatabase({
        host: botConfig.database.redis.host,
        port: botConfig.database.redis.port,
        password: botConfig.database.redis.password,
        db: botConfig.database.redis.db
      });
      DatabaseManager.getInstance().setDatabase(redisDb);
    }
    
    // å¯åŠ¨æ¡†æ¶ï¼ˆå°†è‡ªåŠ¨åŠ è½½é€‚é…å™¨å’Œæ’ä»¶ï¼‰
    await framework.start();
    
    if (!botConfig?.plugins?.autoLoad) {

      try {
    //    const ExamplePlugin = (await import('./plugins/example-plugin/index')).default;
     //   const examplePlugin = new ExamplePlugin();
        await framework.loadPlugin(examplePlugin);
        Logger.info('ç¤ºä¾‹æ’ä»¶åŠ è½½æˆåŠŸ');
        
        // åŠ è½½ç³»ç»Ÿæ’ä»¶
        const SystemPlugin = (await import('./plugins/system-plugin/index')).default;
        const systemPlugin = new SystemPlugin();
        await framework.loadPlugin(systemPlugin);
        Logger.info('ç³»ç»Ÿæ’ä»¶åŠ è½½æˆåŠŸ');
      } catch (error) {
        Logger.error('æ’ä»¶åŠ è½½å¤±è´¥:', error);
      }
    }
   
    // æ˜¾ç¤ºæ¡†æ¶çŠ¶æ€
    const status = framework.getStatus();
    Logger.info(`ğŸ“Š æ¡†æ¶çŠ¶æ€: è¿è¡Œ=${status.isRunning}, æ’ä»¶æ•°=${status.pluginCount}, é€‚é…å™¨æ•°=${status.adapterCount}`);
    
    // ç›‘å¬è¿›ç¨‹é€€å‡º
    process.on('SIGINT', async () => {
      Logger.info('ğŸ›‘ æ­£åœ¨å…³é—­é«˜çº§æœºå™¨äººæ¡†æ¶...');
      await framework.stop();
      process.exit(0);
    });
    
    process.on('uncaughtException', (error) => {
      Logger.error('ğŸš¨ æœªæ•è·çš„å¼‚å¸¸:', error);
    });
    
    process.on('unhandledRejection', (reason, promise) => {
      Logger.error(`ğŸš¨ æœªå¤„ç†çš„Promiseæ‹’ç» at: ${promise}, reason: ${reason}`);
    });
    
  } catch (error) {
    Logger.error('âŒ é«˜çº§æœºå™¨äººæ¡†æ¶å¯åŠ¨å¤±è´¥:', error);
    process.exit(1);
  }
}

main();